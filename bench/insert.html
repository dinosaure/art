<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="https://unpkg.com/d3-simple-slider"></script>
  <script src="https://unpkg.com/simple-statistics@7.0.2/dist/simple-statistics.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/default.min.css">
  <link href="style.css" rel="stylesheet" type="text/css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js"></script>
  <style>
    *{
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body{
    width: 100%;
    height: 100%;
    font-family:Helvetica Neue,metric,sans-serif;
    text-rendering: optimizeLegibility;
}

.center{
    width: 500px;
    margin:auto
}

text{
    font-family: metric,sans-serif;
}

.ml {
    text-align: left
}

svg {
    overflow: hidden;
    margin: auto
}

.axis line, .axis path{
    stroke: #2E3532;
    stroke-width:1px;
}

.axisTitle, .axis text{
    fill: #2E3532;
    font-size:12px;
}

.background {
    fill: #FBFBFB;
    stroke: #2E3532;
}

.axisTitle, .chartTitle{
    text-anchor: middle
}


.ytitle {
    text-anchor: middle;
    transform: rotate(90deg)
}

.warningtext{
    text-anchor: center;
    fill: #F06449;
}

.regLine {
    stroke: #F06449;
    stroke-width:2px;
    opacity:0.7
}

.circle {
    fill: #4ECDC4;
    stroke: #292f36;
    stroke-width:0.3px
}

table {
    margin:auto;
    text-align:left;
    border-spacing: 15px 5px;
    border: 1px solid #2E3532
}

th {
    text-align: center;
    color:#F06449
}


tr {
    fill: #2E3532;
    font-size:10px
}

.tooltip .tooltiptext {
  visibility: hidden;
  width: auto;
  background-color: #F06449;
  color: #FFFFFF;
  text-align: center;
  border-radius: 10px;
  padding: 0 5px 0 5px;
  /* Position the tooltip */
  position: absolute;
  z-index: 1;
}

.tooltip:hover .tooltiptext {
  visibility: visible;
}
.bar {
    fill: #4ECDC4;
    stroke:#292f36;
}
.bar:hover {
    fill: #F06449;
    stroke:#292f36;
    stroke-width:1px;
}

.radio {
    margin: auto;
    width : 200px;
}

.wrapper {
    display: grid;
    margin: 50px 50px 50px 50px;
    gap: 10px 20px;
    grid-auto-rows: minmax(20px, auto);
    text-align: center;
    place-items: center;
}

.mainTitle, .summarizeTitle {
    height:30px;
    width: auto;
    border-radius: 2px;
    padding: 0 45px 0 45px;
    border-style: solid;
    border-width:1px;
    box-shadow: 2px 2px 1px rgba(0,0,0,0.1);
    color:  #2E3532;
    background: #FBFBFB;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}

.slidecontainer{
    width: 50%;
}

  </style>
</head>
<body>

  <script type="text/javascript">
    // structure of JSON
// { xLabel: string,
//   yLabel: string,
//   series: [ tests ] }
//
// tests := { name: string,
//            description: { start : int, sampling: float, stabilize: bool,
//                           quota: float, limit: int, instances: [string],
//                           samples: int, time : float}
//            dataset: [ point ],
//            kde : [ v: float ] (optional)
//            result: { estimate: float, r_square: float (optional) } }
//
// point := { x : double,
//            y : double }
//
// xLabel and yLabel are the same for any tests
window.onload = function () {

const wsvg = 600;
const hsvg = 400;
const wslider = 200;
const hslider = 50;
const margin = {left:50,right:50,top:20,bottom:50};
const dotSize = 1.5;
const innerW = wsvg-(margin.left+margin.right);
const innerH = hsvg-(margin.top+margin.bottom);

const marginbar = {left:150,right:150,top:50,bottom:50};
const wbar = 900;
const innerWbar = wbar-(marginbar.left+marginbar.right);

const SQRT_2PI = Math.sqrt(2 * Math.PI);

// Main function : place containers and call plot functions.
function render(inputs) {
    inputs.series.forEach(
	function(serie) {
	    serie.dataset.forEach(
		function(d) {
		    d.x = +d.x;
		    d.y = +d.y;
		});}
    );

    // First step : check if there is no kde/histogram data at all in
    // the benchmarks, in which case, we want to reduce our layout to
    // one column.
    let nonempty_kde = false;
    inputs.series.forEach(function (serie) {
	if ('kde' in serie) {
	    nonempty_kde = nonempty_kde || true;} });
    const nb_col = nonempty_kde ? 2 : 1;

    // ************************************************ //
    //              Layout of the page                  //
    // ************************************************ //
    // + a summarize bar graph on top
    // + one section for each benchmark which includes
    //     * 1 title
    //     * 1 linear regression graph and its title and information table
    //     * if kde data are available a histogram/kde graph with its control panel.
    //
    // If none of the benchmarks has kde data, the layout is the same
    // but with only one column (no hist/kde graphs).
    //
    //
    //              c1:        c2:
    //
    // r1:            *title*
    //           ___________________
    // r2:      |   summarize bar   |
    //          |___________________|
    //
    // r3:           *title-1*
    //
    // r4:        *title*   *radio*
    //           _______     _______
    // r5:      | lr-1  |   | kde-1 |
    //          |_______|   |_______|
    //
    // r6:      *infos-1*   *slider-1*
    // ..
    // r(4i+3):       *title-i*
    //
    // r(4i+4):  *title*     *radio*
    //           _______     _______
    // r(4i+5): | lr-i  |   | kde-i |
    //          |_______|   |_______|
    //
    // r(4i+6): *infos-i*   *slider-i*
    //
    // etc ..

      const main = d3.select("body")
	  .append("div")
	    .attr("class", "wrapper")
	    .style("grid-template-columns", (nonempty_kde ? "repeat(2,"+wsvg+"px)" : "900px"))
	    .attr("id", "main");

    // ************************************************ //
    //              Summarize bar graph                 //
    // ************************************************ //

    // Title
    main.append("div")
   	  .style("grid-row", "1")
      	.style("grid-column", "1 / "+(nb_col+1))
  	  .attr("class", "summarizeTitle")
  	.text("Benchmarks summary");

    // Bar graph
    let bar_container = main
	.append("div")
   	  .style("grid-row", "2")
      	  .style("grid-column", "1 / "+(nb_col+1))
	  .attr("id", "bar");
    plot_summarize_bar_graph(bar_container, inputs);


    // ************************************************ //
    //              Layout for lr/kde graphs            //
    // ************************************************ //

    // Benchmark titles
    const titles = main
	  .selectAll(".mainTitle")
	  .data(inputs.series)
	  .enter()
	  .append("div")
	    .attr("id", (data, i) => "title-"+i)
   	    .style("grid-row", (data,i) =>""+(4*i+3))
      	    .style("grid-column", "1 / "+(nb_col+1))
  	    .attr("class","mainTitle")
	  .append("text")
  	    .attr("x", wsvg)
  	    .attr("y", margin.top-10)
            .text((data, i) => "#"+data.name);

    // Linear regression graph titles
    const titles_lr = main
	  .selectAll("#title_lr")
	  .data(inputs.series)
	  .enter()
	  .append("div")
            .attr("id",  "title_lr")
   	    .style("grid-row", (data,i) =>""+(4*i+4))
   	    .style("grid-column", "1")
	  .append("text")
  	    .attr("class","chartTitle")
  	    .text("Linear regression");

    // Containers for linear regression graphs
    const lr_graphs = main
	  .selectAll(".lr")
	  .data(inputs.series)
	  .enter()
	  .append("div")
            .attr("class", "lr")
	    .attr("id", (data, i) => "linearRegression-"+i)
   	    .style("grid-row", (data,i) =>""+(4*i+5))
   	  .style("grid-column", "1");

    // Containers for linear regression info tables
    const lr_info = main
	  .selectAll(".lr-info")
	  .data(inputs.series)
	  .enter()
	  .append("div")
            .attr("class", "lr-info")
	    .attr("id", (data, i) => "lr-info-"+i)
   	    .style("grid-row", (data,i) =>""+(4*i+6))
            .style("grid-column", "1");

    let radio_div, kde_graphs, kde_controler;
    if (nonempty_kde) {
	// Containers for radio buttons to choose between histogram/kde plots
	radio_div = main
	      .selectAll(".radio_div")
	      .data(inputs.series)
	      .enter()
	      .append("div")
              .attr("class",  "radio")
	      .attr("id", (d, i) => "radio_div"+i)
   	      .style("grid-row", (data,i) =>""+(4*i+4))
   	      .style("grid-column", "2");

	// Containers for kde/hist graph
	kde_graphs = main
	      .selectAll(".kde")
	      .data(inputs.series)
	      .enter()
	      .append("div")
              .attr("class", "kde")
	      .attr("id", (data, i) => "histKde-"+i)
   	      .style("grid-row", (data,i) =>""+(4*i+5))
   	      .style("grid-column", "2");

	// Containers for kde/hist controlers
	kde_controler = main
	      .selectAll(".kde-controler")
	      .data(inputs.series)
	      .enter()
	      .append("div")
              .attr("class", "kde-controler")
	      .attr("id", (data, i) => "kde-controler-"+i)
   	      .style("grid-row", (data,i) =>""+(4*i+6))
              .style("grid-column", "2");
    }

    // ************************************************ //
    //          Linear regression graph                 //
    // ************************************************ //
    lr_graphs.each( function(serie, i) {
	//Curves for each input
	const xMin = 0;
	const xMax = d3.max(serie.dataset, d => d.x);
	const yMin = 0;
	const yMax = d3.max(serie.dataset, d => d.y);

	// Define x axis
	const xScale = d3.scaleLinear()
  	      .domain([xMin,xMax])
  	      .range([0,innerW])
  	      .nice();
	const xAxis = d3.axisBottom()
  	      .scale(xScale)
  	      .ticks(8, "s");
	// "s" = number format such as 1000 -> 1k

	// Define y axis
	const yScale = d3.scaleLinear()
  	      .domain([yMin,yMax])
  	      .range([innerH,0])
  	      .nice();
	const yAxis = d3.axisLeft()
  	      .scale(yScale)
  	      .ticks(8, "s");

	// Svg
  	const plot = d3.select(this)
	    .append("svg")
  	      .attr("width",wsvg)
  	      .attr("height",hsvg);
	// Color background
	plot.append("rect")
  	    .attr("x",margin.left)
  	    .attr("y",margin.top)
  	    .attr("width",innerW)
  	    .attr("height",innerH)
  	    .attr("class","background axis");
	// Plot axis
	plot.append("g")
  	    .attr("transform",
	 	  "translate("+margin.left+","
	 	  +(hsvg-margin.bottom)+")")
	    .attr("class", "axis")
  	    .call(xAxis);
	plot.append("g")
  	    .attr("transform",
	  	  "translate("+margin.left+","
		  +margin.top+")")
	    .attr("class", "axis")
  	    .call(yAxis);
	// Print axis titles
	plot.append("text")
	    .attr("class", "axisTitle")
	    .attr("x", wsvg/2)
	    .attr("y", hsvg-10)
	    .text(inputs.xLabel);
	plot.append("text")
	    .attr("class", "axisTitle ytitle")
	    .attr("transform-origin", 0, hsvg/2)
	    .attr("x", 0)
	    .attr("y", hsvg/2)
	    .text(inputs.yLabel);

	// Plot data
	plot.append("g")
	    .attr("transform",
		  "translate("+margin.left+","
		  +margin.top+")")
  	    .selectAll("circle")
  	    .data(serie.dataset)
  	    .enter()
  	    .append("circle")
	    .attr("class", "circle")
  	    .attr("r", dotSize)
  	    .attr("cx", d => xScale(d.x))
  	    .attr("cy", d => yScale(d.y));

	// Plot linear regression line

	const xVals = serie.dataset.map((e,j) => e.x);
	const yVals = serie.dataset.map((e,j) => e.y);
	const pairs = [];
	xVals.forEach((d,i) => pairs.push([xVals[i],yVals[i]]));
	const linReg = ss.linearRegression(pairs);
	const linRegLine = ss.linearRegressionLine(linReg);
	let line = plot
	    .append("line")
    	      .attr("transform","translate("+margin.left+","+margin.top+")")
    	      .attr("class","regLine")
    	      .attr("x1",xScale(xMin))
    	      .attr("x2",xScale(xMin))
    	      .attr("y1",yScale(linRegLine(xMin)))
    	      .attr("y2",yScale(linRegLine(xMin)));
	line.transition().duration(1000).delay(2000)
    	      .attr("x2",xScale(xMax))
    	      .attr("y2",yScale(linRegLine(xMax)));

	// Add text boxes
	//const meanX = ss.mean(xVals).toFixed(0);
	//const meanY = ss.mean(yVals).toFixed(2);
	//const varX = ss.sampleVariance(xVals).toFixed(0);
	//const varY = ss.sampleVariance(yVals).toFixed(1);
	//const corCoeff = ss.sampleCorrelation(xVals,yVals).toFixed(3);

	const lr_results = [
	    ["Linear regression line", "y = "+linReg.b.toFixed(2)+" + "+linReg.m.toFixed(3)+"x"],
	    ["Coefficient", serie.result.estimate],
	    ["R²", serie.result.r_square]
	];

	const sampling_to_string = sampling =>
              (Number.isInteger(sampling) ?  "`Linear "+sampling+"" : "`Geometric "+sampling+"");

	const format = v  => d3.format("s")(v);

	const param_benchmarks = [
	    ["LR sampling (sampling)", sampling_to_string(serie.description.sampling)],
	    ["Start (start)", serie.description.start],
	    ["Benchmark runtime (time / quota)",
	     format(serie.description.time) + " / " + format(serie.description.quota)],
	    ["Number of runs (samples)", serie.description.samples + " / " + serie.description.limit],
	    ["Stabilized GC (stabilize)", serie.description.stabilize]
	];

	const table = d3.select("#lr-info-"+i)
	      .append("table");

	table.append("thead")
	    .append("tr")
	    .append("th")
	    .attr("colspan", 2)
	    .attr("scope", "col")
	    .text("Linear regression results");

	table.append("tbody")
	    .selectAll("tr")
	    .data(lr_results)
	    .enter()
	    .append("tr")
	    .selectAll("td")
	    .data(d => d)
	    .enter()
	    .append("td")
	    .text(d=>d);

	table.append("thead")
	    .append("tr")
	    .append("th")
	    .attr("class", "tooltip")
	    .attr("colspan", 2)
	    .attr("scope", "col")
	    .text("Benchmarks parameters")
	    .append("span")
	    .attr("class","tooltiptext")
	    .text("See [Benchmarks.stats]");

	table.append("tbody")
	    .selectAll("tr")
	    .data(param_benchmarks)
	    .enter()
	    .append("tr")
	    .selectAll("td")
	    .data(d => d)
	    .enter()
	    .append("td")
	    .text(d=>d);

    });

    // ************************************************ //
    //         Histogram and kde graphs                 //
    // ************************************************ //
    if (nonempty_kde) {
        kde_graphs.each(function (serie, i) {

	    // Svg for histogram and kde graphs
	    let pdfgraph = d3.select(this)
		.append("svg")
		.attr("id", "pdfgraph")
		.attr("width", wsvg)
		.attr("height", hsvg)
		.append("g")
		.attr("transform", "translate("+margin.left+","+margin.top+")");

	    // If there is no kde field in the data [serie], some note
	    // is written in the svg window.
	    if (!('kde' in serie)) {
		pdfgraph.append("text")
		    .attr("x", (margin.left+margin.right+wsvg)/2)
		    .attr("y", (margin.top+margin.bottom+hsvg)/2)
		    .attr("class", "warning")
		    .text("No available data");
	    } else if (d3.max(serie.kde) == d3.min(serie.kde)) {
		pdfgraph.append("text")
		    .attr("x", wsvg/2)
		    .attr("y", hsvg/2)
		    .attr("class", "warningtext")
		    .text("All data have same value.");
	    } else {
		const data = serie.kde;
		//Some default values
		const min_slider = (d3.max(data)-d3.min(data))/data.length;
		const max_slider = (d3.max(data)-d3.min(data))/30;
		let vslider = min_slider;

		//Radio buttons
		const form = d3.select("#radio_div"+i)
		      .append("form");

		form.append("input")
		    .attr("type", "radio")
		    .attr("name", "graph")
		    .attr("value", "hist"+i)
		    .attr("name", "graph")
		    .attr("checked", "checked")
		    .on("change", () => plot_chosen_graph(d3.select(this), "hist"));
		form.append("label")
		    .attr("for", "hist"+i)
		    .text("Histogram");
		form.append("input")
		    .attr("type", "radio")
		    .attr("value", "kde"+i)
		    .attr("name", "graph")
		    .on("change", () => plot_chosen_graph(d3.select(this), "kde"));
		form.append("label")
		    .attr("for", "kde"+i)
		    .text("KDE");

		//axis
		const min = d3.min(data),
		      max = d3.max(data);
		const minX = d3.max([0, min-max_slider]),
		      maxX = max+max_slider;

		//X axis is the same for both graphs (histogram and kde)
		const xscale = d3.scaleLinear()
		      .range([0, innerW])
		      .domain([minX, maxX])
		      .nice();
		const xAxis = d3.axisBottom()
		      .scale(xscale)
		      .ticks(8, "s");

		//Y axis has a different domain value between both graphs.
		//So yscale.domain() is defined individually for each plot.
		const yscale = d3.scaleLinear()
		      .range([0, innerH])
		      .nice();
		const yAxis = d3.axisLeft()
		      .scale(yscale)
		      .ticks(8, "s");

		//x value for kde graph
		const n = 1000;
		const x = Array(n);
		const xmin = d3.min(xscale.domain()),
		      xmax = d3.max(xscale.domain());
		for (let i=0; i<n; i++) { x[i] = xmin + i*(xmax-xmin)/n; }

		//Compute kde function for min bandwidth value to determine to determine
		//the max value of Y axis. Only happens one time when loading the webpage.
		const kde = kernelDensityEstimation(data, min_slider);
		const v = new Array(n);
		for (let i=0; i<n;i++){ v[i] = kde(x[i]);}
		const maxYkde = d3.max(v),
		      maxYhist = d3.max(histogram(data, max_slider, min, max));

		//background
		pdfgraph
		    .append("rect")
  		    .attr("x", 0)
  		    .attr("y", 0)
  		    .attr("width", innerW)
  		    .attr("height", innerH)
  		    .attr("class","background axis");

		// x Axis
		const gxAxis = pdfgraph
	              .append("g")
	              .attr("transform","translate(0"+","+innerH+")")
	              .attr("class", "axis")
	              .call(xAxis);

		// y Axis
		const gyAxis = pdfgraph
	              .append("g")
	              .attr("class", "axis")
	              .call(yAxis);

		// X Axis title
		pdfgraph.append("text")
		    .attr("class", "axisTitle")
		    .attr("x", innerW/2)
		    .attr("y", innerH+40)
		    .text("Estimated "+inputs.yLabel);

		plot_chosen_graph(d3.select(this), "hist");

		function plot_chosen_graph(container, choice) {


		    container.selectAll(".bar").remove();
		    container.select(".mypath").remove();
		    container.select(".ytitle").remove();

		    // Erasing control panels if it exists and initializing it
		    const control_container = d3.select("#kde-controler-"+i);
		    const slider = control_container.select("#slider-"+i);
		    const slidertitle = control_container.select("#slidertitle-"+i);
		    if (!slider.empty())  {
			slider.remove();
		    }
		    if (!slidertitle.empty())  {
			slidertitle.remove();
		    }

		    //Hist part
		    if (choice=="hist") {
			// Defined yAxis
			yscale.domain([maxYhist, 0]).nice();
			yAxis.scale(yscale);
			gyAxis.call(yAxis);

			// y Axis title
			pdfgraph.append("text")
			    .attr("transform-origin", "10 "+(innerH/2))
			    .attr("class", "axisTitle ytitle")
			    .attr("x", 10)
			    .attr("y", innerH/2)
			    .text("Count");

			const barwidth = vslider;

			const update_hist =
			      plot_histogram(pdfgraph, data, barwidth, xscale, yscale);

			//slider
			control_container
			    .insert("p")
			    .attr("align", "center")
			    .attr("id", "slidertitle-"+i)
			    .text("Barwidth");

			control_container
			    .insert("svg")
			    .attr("width", wsvg)
			    .attr("height", hslider)
			    .attr("id", "slider-"+i)
			    .append("g")
			    .attr("transform", "translate("+(wsvg-wslider)/2+",10)")
			    .call(d3
				  .sliderBottom()
				  .min(min_slider)
				  .max(max_slider)
				  .width(wslider)
				  .ticks(5, "s")
				  .default(vslider)
				  .fill("red")
				  .on("onchange", (value) => {
				      if (value > 0) {
					  vslider=value;
					  update_hist(vslider);}}));
		    } else {
			//Defined yAxis
			yscale.domain([maxYkde, 0]).nice();
			yAxis.scale(yscale);
			gyAxis.call(yAxis);

			// y Axis title
			pdfgraph.append("text")
			    .attr("transform-origin", "10 "+(innerH/2))
			    .attr("class", "axisTitle ytitle")
			    .attr("x", +10)
			    .attr("y", innerH/2)
			    .text("Density");

			const bandwidth = vslider;
			const update_kde = plot_kde(pdfgraph, data, bandwidth, xscale, yscale, x);

			//slider
			control_container.insert("p")
			    .attr("align", "center")
			    .attr("id", "slidertitle-"+i)
			    .text("Bandwidth");

			control_container.insert("svg")
			    .attr("width", wsvg)
			    .attr("height", hslider)
			    .attr("id", "slider-"+i)
			    .append("g")
			    .attr("transform", "translate("+(wsvg-wslider)/2+",10)")
			    .call(d3
				  .sliderBottom()
				  .min(min_slider)
				  .max(max_slider)
				  .width(wslider)
				  .ticks(5, "s")
				  .default(vslider)
				  .fill("red")
				  .on("onchange", (value) =>
				      {if (value > 0) { vslider=value; update_kde(vslider);}}));
		    }; // end else
		}; // end function
	    }; //end else (available kde data)
	}); //end function // end each
    }; //end if



function plot_summarize_bar_graph(container, inputs) {

    const hbar = d3.min([60*inputs.series.length, hsvg]);
    const innerHbar = hbar - marginbar.top - marginbar.bottom;

    const xb = d3.scaleLinear()
	  .range([0, innerWbar])
	  .domain([0, d3.max(inputs.series, serie => serie.result.estimate)])
	  .nice();
    const yb = d3.scaleBand()
	  .range([0, innerHbar])
	  .padding(0.2)
	  .domain(inputs.series.map(serie => serie.name));
    const xbAxis = d3.axisBottom()
	  .scale(xb)
	  .ticks(8, "s");
    const ybAxis = d3.axisLeft()
	  .scale(yb);

    const bargraph =
	container.append("svg")
	.attr("width", wbar)
	.attr("height", hbar);

    // background
    bargraph.append("rect")
  	.attr("x", marginbar.left)
  	.attr("y", marginbar.top)
  	.attr("width", innerWbar)
  	.attr("height", innerHbar)
  	.attr("class", "background axis");
    // x Axis
    bargraph.append("g")
	.attr("transform","translate("+marginbar.left+","+(hbar-marginbar.bottom)+")")
	.attr("class", "axis")
	.call(xbAxis);
    // x axis title
    bargraph.append("text")
	.attr("class", "axisTitle")
	.attr("x", wbar/2)
	.attr("y", hbar-10)
	.text("Estimated "+inputs.yLabel);
    // y Axis
    bargraph.append("g")
	.attr("transform","translate("+marginbar.left+","+marginbar.bottom+")")
	.attr("class", "axis")
	.call(ybAxis);

    // Bargraph
    bargraph.append("g")
	.attr("transform","translate("+marginbar.left+","+marginbar.top+")")
	.selectAll(".bar")
   	.data(inputs.series)
	.enter()
	.append("rect")
	.attr("class", "bar")
	.attr("y", serie => yb(serie.name))
	.attr("height", yb.bandwidth)
	.attr("x", serie => 0)
	.attr("width", serie => xb(serie.result.estimate))
	.attr("fill", "#4ECDC4")
	.on("mouseover", function (serie) {
	    // Specify where to put label of text
	    bargraph.append("text")
		.attr("class", "axisTitle")
		.attr("id", "tt")
		.attr("x", wbar-200)
		.attr("y", marginbar.top-10)
		.text("Value: "+d3.format(".4s")(serie.result.estimate));
	})
        .on("mouseout", function (serie) {
	    // Select text by id and then remove
	    d3.selectAll("#tt").transition().duration("50").remove();
	});

};

// [histrogram (data, barwidth, min, max)] computes histogram
// values as follows:
// - a value [v] of [data] contributes to the bar between [u] and
// [u+barwidth] if u <= v < u+barwidth
// - the [i]th bar is between [min+i*barwidth] and [min+(i+1)*barwidth]
// - [max] is used only to determine the number of bars. It MUST be greater
// than [d3.max(data)]
function histogram(data, barwidth, min, max) {
    const nbar = Math.floor((max-min)/barwidth)+1;
    let hist = new Array(nbar);
    for (let i=0; i<nbar; i++) {
	hist[i]=0;
    }

    data.forEach(function(v) {
	const ind = Math.floor((v-min)/barwidth);
	hist[ind] ++;
    });

    let n = data.length;
    for (let i=0; i<nbar; i++) {
	hist[i] = hist[i];
    }

    return hist;
}

// [plot_histogram(container, data, bandwidth, xscale, yscale)]
// draws the histogram computes with
// [histogram(data, barwidth, d3.min(data), d3.max(data)]
// in the html element [container].
//
// Axis are already defined on [container], using [xscale] and [yscale].
//
// In addition, this function returns the update function
// that redraw the bar if called with a new barwidth.
function plot_histogram(container, data, barwidth, xscale, yscale) {
    const min = d3.min(data),
	  max = d3.max(data);
    const hist = histogram(data, barwidth, min, max);
    const sample_nb = data.length;

    const print_value = function (v) {
	container.append("text")
	    .attr("class", "axisTitle")
	    .attr("id", "tt2")
	    .attr("x", wsvg-170)
	    .attr("y", 20)
	    .text("Value: "+d3.format("d")(v)+" / "+d3.format("d")(sample_nb));};

    const rects = container
	  .selectAll(".bar")
   	  .data(hist)
	  .enter();

    rects.append("rect")
	.attr("class", "bar")
	.attr("x", (v, i) => xscale(i*barwidth+min))
	.attr("width", (v, i) => xscale(barwidth)-xscale(0))
	.attr("y", (v, i) => yscale(v))
	.attr("height", (v, i) => innerH-yscale(v))
	.on("mouseover", print_value)
        .on("mouseout", () => d3.selectAll("#tt2").transition().duration("50").remove());

    function update_hist(nbarwidth) {
	//compute new histograph values
	const nhist = histogram(data, nbarwidth, min, max);

	const rects = container
	      .selectAll(".bar")
   	      .data(nhist);

	rects.exit().remove();

	rects.enter().append("rect").attr("class", "bar")
	    .merge(rects)
	    .attr("x", (v, i) => xscale(i*nbarwidth+min))
	    .attr("width", (v, i) => xscale(nbarwidth)-xscale(0))
	    .attr("y", (v, i) => yscale(v))
	    .attr("height", (v, i) => innerH-yscale(v))
	    .on("mouseover", print_value)
            .on("mouseout", () => d3.selectAll("#tt2").transition().duration("50").remove());
    }
    return update_hist;
};

// [kernelDensityEstimation(data, bandwith] returns the function x -> kde(x)
//    for [data]. The kernel function used is a gaussian.
function kernelDensityEstimation(X, bandwidth) {
    //gaussian constante
    const a = 1/(2*bandwidth*bandwidth);
    const b = bandwidth * SQRT_2PI;
    const gaussianKernel =
	  function (x) {
	      return Math.exp(-a * x * x) / b;
	  };

    return function (x) {
        let i = 0;
        let sum = 0;
        for (i = 0; i < X.length; i++) {
	    sum += gaussianKernel(x - X[i])/X.length;
        }
	return sum ;
    };
}

// [plot_kde(container, data, bandwidth, xscale, yscale, x)] draws
// the kde function computes with [kde(data, bandwidth)]
// for the abscisse values defined by [x], in the html element
// [container].
//
// Axis are already defined on [container], using [xscale] and
// [yscale].
//
// In addition, this function returns the update function that
// redraw the curve if called with a new bandwidth.
function plot_kde(container, data, bandwidth, xscale, yscale, x) {
    const n = x.length;
    const kde = kernelDensityEstimation(data, bandwidth);
    const density = new Array(n);

    for (let i=0; i<n;i++){
	let tmp = x[i] ;
	density[i] = [tmp, kde(tmp)];
    }

    const graph = container
	  .append('g')
	  .append("path")
	  .attr("class", "mypath")
	  .datum(density)
	  .attr("fill", "#4ECDC4")
	  .attr("opacity", ".8")
	  .attr("stroke", "#292F36")
	  .attr("stroke-width", 1)
	  .attr("stroke-linejoin", "round")
	  .attr("d",
		d3.line()
		.curve(d3.curveBasis)
		.x(d => xscale(d[0]))
		.y(d => yscale(d[1])));

    function update_kde(nbandwidth) {
	let kde = kernelDensityEstimation(data, nbandwidth);

	for (let i=0; i<n;i++){
	    density[i][1] = kde(density[i][0]);
	}

	graph.datum(density)
	    .transition()
	    .duration(50)
	    .attr("d",
		  d3.line()
		  .curve(d3.curveBasis)
		  .x(d => xscale(d[0]))
		  .y(d => yscale(d[1])));
    };

    return update_kde;
};

};


var contents = null;
contents = {"xLabel":"run","yLabel":"monotonic-clock","series":[{"name":"insert/art","description":{"start":1,"sampling":1.01,"stabilize":true,"quota":2000000000,"limit":3000,"instances":["minor-allocated","major-allocated","monotonic-clock"],"samples":165,"time":2152038795},"dataset":[{"x":1,"y":141711},{"x":2,"y":334671},{"x":3,"y":458095},{"x":4,"y":579548},{"x":5,"y":709236},{"x":6,"y":891152},{"x":7,"y":997502},{"x":8,"y":1091318},{"x":9,"y":1241485},{"x":10,"y":1337638},{"x":11,"y":1453483},{"x":12,"y":1570817},{"x":13,"y":1759579},{"x":14,"y":1814382},{"x":15,"y":1968706},{"x":16,"y":2072489},{"x":17,"y":2194850},{"x":18,"y":2318577},{"x":19,"y":2506441},{"x":20,"y":2716209},{"x":21,"y":2735249},{"x":22,"y":2860062},{"x":23,"y":3021074},{"x":24,"y":3113139},{"x":25,"y":3238877},{"x":26,"y":3442597},{"x":27,"y":3569128},{"x":28,"y":3744665},{"x":29,"y":3821086},{"x":30,"y":3941089},{"x":31,"y":4071111},{"x":32,"y":4200422},{"x":33,"y":4329922},{"x":34,"y":4452918},{"x":35,"y":4622090},{"x":36,"y":4701126},{"x":37,"y":4823703},{"x":38,"y":4981035},{"x":39,"y":5144468},{"x":40,"y":5320124},{"x":41,"y":5399029},{"x":42,"y":5569842},{"x":43,"y":5697389},{"x":44,"y":5772540},{"x":45,"y":5954437},{"x":46,"y":6040470},{"x":47,"y":6468196},{"x":48,"y":6286742},{"x":49,"y":6407645},{"x":50,"y":6579130},{"x":51,"y":6791319},{"x":52,"y":7001105},{"x":53,"y":7041463},{"x":54,"y":7269064},{"x":55,"y":7354222},{"x":56,"y":7471325},{"x":57,"y":7547814},{"x":58,"y":7715139},{"x":59,"y":7843728},{"x":60,"y":7959973},{"x":61,"y":8054514},{"x":62,"y":8173182},{"x":63,"y":8395275},{"x":64,"y":8492209},{"x":65,"y":8678161},{"x":66,"y":8906531},{"x":67,"y":8958142},{"x":68,"y":9051405},{"x":69,"y":9133395},{"x":70,"y":9393949},{"x":71,"y":9557470},{"x":72,"y":9989085},{"x":73,"y":9810513},{"x":74,"y":9944827},{"x":75,"y":10253074},{"x":76,"y":10208451},{"x":77,"y":10300714},{"x":78,"y":10374062},{"x":79,"y":10565348},{"x":80,"y":10678798},{"x":81,"y":10753840},{"x":82,"y":11013434},{"x":83,"y":11050677},{"x":84,"y":11124822},{"x":85,"y":11254207},{"x":86,"y":11521204},{"x":87,"y":11564803},{"x":88,"y":11669425},{"x":89,"y":11955131},{"x":90,"y":12184307},{"x":91,"y":12299373},{"x":92,"y":12370575},{"x":93,"y":12457771},{"x":94,"y":12523514},{"x":95,"y":12697342},{"x":96,"y":12818857},{"x":97,"y":13303827},{"x":98,"y":13057179},{"x":99,"y":13196996},{"x":100,"y":13282377},{"x":101,"y":13504787},{"x":102,"y":13643297},{"x":103,"y":13755332},{"x":104,"y":13901909},{"x":105,"y":14114157},{"x":106,"y":14347136},{"x":107,"y":14260293},{"x":108,"y":14396554},{"x":109,"y":14514507},{"x":110,"y":14644198},{"x":111,"y":14760073},{"x":112,"y":14875660},{"x":113,"y":14971069},{"x":114,"y":15137991},{"x":115,"y":15287042},{"x":116,"y":15444866},{"x":117,"y":15559110},{"x":118,"y":15658711},{"x":119,"y":15811047},{"x":120,"y":16003138},{"x":121,"y":16075717},{"x":122,"y":16552696},{"x":123,"y":16383604},{"x":124,"y":16514346},{"x":125,"y":16571833},{"x":126,"y":16717279},{"x":127,"y":16969829},{"x":128,"y":17093088},{"x":129,"y":17287502},{"x":130,"y":17420755},{"x":131,"y":17588705},{"x":132,"y":17636215},{"x":133,"y":17805183},{"x":134,"y":17844375},{"x":135,"y":18127951},{"x":136,"y":18096373},{"x":137,"y":18326471},{"x":138,"y":18393944},{"x":139,"y":18488812},{"x":140,"y":18655868},{"x":141,"y":18856262},{"x":142,"y":18915799},{"x":143,"y":19049094},{"x":144,"y":19194898},{"x":145,"y":19287724},{"x":146,"y":19424468},{"x":147,"y":19582245},{"x":148,"y":19781315},{"x":149,"y":19795872},{"x":150,"y":19976357},{"x":151,"y":20084006},{"x":152,"y":20298620},{"x":153,"y":20361228},{"x":154,"y":20494713},{"x":155,"y":20676649},{"x":156,"y":20838966},{"x":157,"y":20859492},{"x":158,"y":21168784},{"x":159,"y":21499526},{"x":160,"y":21694757},{"x":161,"y":21548947},{"x":162,"y":21767655},{"x":163,"y":21742638},{"x":164,"y":21979572},{"x":165,"y":22054756}],"kde":[131528,126032,125036,124763,124730,124921,126844,124834,125143,123822,124156,164891,232761,129239,126242,125515,126117,124225,125131,125334,125326,124160,123712,125177,124253,185611,131148,126728,125143,125077,125189,125234,124801,125258,124905,123844,124091,254286,129719,126015,125851,125013,125918,125757,125843,124700,125418,124748,124919,125660,191125,128572,126513,125901,125488,125520,130651,125666,125532,124793,123956,125506,254059,131248,126366,125577,125182,124159,126074,125320,124985,125458,124123,125178,124861,184773,129079,125561,125364,125714,125474,125225,125748,125166,125145,124697,129362,125419,192091,128359,126277,126060,124904,124770,125975,124675,126212,124153,125178,125310,253244,130232,126129,125244,125011,124940,125049,125739,124915,125642,124506,125576,124810,188968,129501,126967,133596,126624,124500,124991,125960,124446,125345,123814,126399,250529,130704,126089,124460,125247,124347,124787,125068,124407,125423,143811,149415,165513,180832,130565,126374,126144,125397,125023,126170,128401,126012,125314,124446,124331,124678,192089,128892,126889,125914,125161,124621,125389,125026,124446,124811,123622,125349,253779,131022,125972,125160,125536,125235,125408,126293,124972,125722,124217,124454,125280,192588,129794,126980,125861,126480,125408,126223,125295,124822,124466,124046,124930,124979,190601,128283,126553,125944,126076,125190,125444,124983,124995,124367,123694,124905,489144,138494,131471,126307,126187,125687,125810,126656,125243,126216,124181,124996,125470,218843,129311,126098,125058,125257,124995,125531,126273,125035,125499,124129,124530,312736,131044,126256,125074,124808,124859,125518,133516,125951,125390,124246,124573,125244,207571,130344,125739,125045,124996,124304,126271,126083,124624,124811,124583,125521,125395,216074,128720,126449,125928,124373,143980,150768,163897,125408,124661,125051,143786,313261,132005,126870,125373,125072,126202,125872,125843,125060,124957,124268,124799,124798,214787,129500,127156,125122,125511,125247,125639,125979,124739,124821,123291,125163,203589,130157,149249,131309,145726,124596,125181,125982,124626,125812,124303,124413,124685,203473,130679,126347,126466,124919,124975,125337,124810,125599,125024,123957,124377,125287,217606,128915,127316,126339,125416,125493,130120,126352,124911,124915,123141,124917,313805,131941,125720,124863,126232,124811,126770,125752,124821,125629,124641,124693,125100,211251,130224,125625,125771,125759,125428,126671,125794,125172,124749,124449,133073,125847,214385,127803,126201,124857,124818,124547,126513,125145,125716,124950,123967,125332,308296,132171,126795,124294,125164,124590,124793,126469,125143,126381,124197,125314,124943,216953,155070,154539,162106,125356,125055,125124,125981,125344,125675,124844,125244,311701,132100,126316,125186,125880,124849,124802,125912,125477,125401,125749,124240,125526,206109,129541,126069,125295,125032,123981,152639,143065,124652,125119,124169,125096,125398,222852,129817,126515,125690,124260,124969,125682,125160,125630,124218,123957,124831,582542,132431,126899,125490,124583,125369,124841,126522,129935,125758,124878,124547,125605,187208,129730,127357,125483,126321,125013,125238,125632,135520,136968,135977,136046,135945,202306,135847,136658,136198,136453,136184,136513,136217,135753,135117,134948,140680,287749,138086,136358,137629,134728,135673,137828,136772,136288,136093,135397,136319,136597,206833,136418,136195,135450,136053,136618,136524,136487,135414,136084,134474,135951,291714,136376,148110,130640,163630,148947,150768,143486,125711,125739,124891,124780,125281,183941,128733,126067,126172,125080,125533,126359,125759,125345,124508,125281,125022,125800,192814,128562,126646,125353,128716,125917,125896,125075,126148,125354,125672,125528,274062,150896,137827,126815,146811,129515,141718,126172,146344,146718,124898,126172,125281,188789,129634,126874,126013,125270,124400,125024,125679,129240,125684,123940,125712,250052,131468,125988,124654,125143,125193,124489,125860,124648,124954,125042,124405,125863,179310,129560,126752,124481,125700,124387,125950,125369,125067,125041,123973,124909,125777,194159,128748,126622,126592,124719,124394,125536,125326,124570,124427,123475,124846,250736,129794,126938,126343,125531,124829,125680,150250,124984,125696,124794,124872,125237,185158,143334,129537,126132,127220,138015,172084,128406,124938,127893,123930,124849,125024,190782,167891,151740,144172,125865,125307,172112,126452,125026,133072,124434,124699,251284,129682,126509,124543,124930,125305,220195,128946,130070,125673,124593,124460,125211,189602,128987,126012,125236,125274,124520,171036,127732,125336,125716,123864,125054,250122,130308,125629,124827,125521,124015,125189,228762,126555,125477,125003,124548,129481,183086,128629,126356,125668,124615,125553,169302,128662,125642,125699,125145,124367,125867,190805,128225,126252,125784,124793,124240,266086,129025,126797,125926,126905,125431,125050,125480,124508,130102,125095,124803,125729,202008,128050,126815,125683,125334,125411,132348,125341,125991,124836,124322,125642,321974,130918,125962,125732,125688,125000,131199,126839,125632,125803,124406,124926,125460,226084,128821,126244,125832,124799,146740,136935,144310,125129,126551,144075,129401,389370,141299,136728,148320,129878,143844,125367,133509,126383,126220,125398,124945,146879,323836,145407,152091,145555,125222,125192,130301,126853,125358,125031,125475,125497,125821,220051,128251,126411,125442,125166,125257,129590,125468,124973,124954,124486,125486,324037,131850,127744,125434,125505,150949,130978,148948,125419,125641,124354,124379,125340,219050,129596,126769,125855,124822,124546,127976,126305,125062,124668,124241,124977,124982,209333,125797,125245,124853,124831,124621,127502,124540,125046,149483,130464,145481,324426,130778,126864,126165,125441,126403,129232,126568,124994,125366,124092,125187,125873,220218,129270,126705,127241,125859,125970,134646,125556,125477,124696,124192,125648,351298,158585,142845,126023,126025,124895,126748,138121,126271,125656,124730,125271,125738,215426,129779,126166,125510,125533,143588,160068,149322,142399,125935,124413,125331,125014,220377,128524,150540,131433,149336,133473,135547,125947,126193,124969,125523,125499,320032,132171,126587,124703,124865,124892,125164,134139,124669,125820,124912,125280,125077,218890,128941,126577,124926,125796,125160,158717,132049,143051,125893,123811,125785,318088,132207,127397,125182,125386,124220,125635,131345,124992,125353,125631,124173,125785,210070,131197,126225,125370,124954,124860,237740,130413,125959,148583,129832,143338,125725,220446,129796,126848,125432,125028,124730,125856,124770,124861,124563,122862,125160,318941,131341,127285,124708,125754,124441,125208,224113,124737,126043,124072,124442,132046,214565,129472,127219,125448,125966,124755,168363,128410,125814,124694,123979,125016,124885,209771,126042,126152,125323,124865,125272,169527,125522,124876,124749,143664,149930,601377,135182,145408,125852,124831,126166,800749,141334,127270,127736,127585,127170,127654,195036,129168,126704,126720,125944,125662,126503,125601,125117,124353],"result":{"estimate":133524.8876046895,"r_square":0.9998044799142329}},{"name":"insert/hashtbl","description":{"start":1,"sampling":1.01,"stabilize":true,"quota":2000000000,"limit":3000,"instances":["minor-allocated","major-allocated","monotonic-clock"],"samples":15,"time":4230065382},"dataset":[{"x":1,"y":18276495},{"x":2,"y":36650104},{"x":3,"y":54792276},{"x":4,"y":73285709},{"x":5,"y":93093420},{"x":6,"y":109539944},{"x":7,"y":128690495},{"x":8,"y":146624893},{"x":9,"y":164820515},{"x":10,"y":183146894},{"x":11,"y":201872567},{"x":12,"y":219624906},{"x":13,"y":239062033},{"x":14,"y":256905411},{"x":15,"y":275497781}],"kde":[18393739,18288818,18304981,18332455,18284990,18292190,18374289,18305896,18372969,18297065,18300846,18286056,18314860,18408471,18402009,18480582,18454975,18343708,18294884,18336099,18285450,18330580,18286294,18286314,18352964,18356438,18375371,19910234,18292044,18280231,18301421,18284548,18278600,18404702,18342903,18365264,18269573,18287736,18276734,18288824,18330063,18312804,18329636,18306704,18290642,18365419,18279921,18319451,18289548,18405907,18325503,18403381,18455149,18346477,18291138,18493311,18286316,18389282,18280599,18300381,18270354,18287059,18281748,18374216,18312257,18430633,18279673,18363526,18616926,18417482,20112797,18410968,18307509,18337529,18399042,18270660,18305723,18333380,18318257,18375132,18275505,18296353,18286193,18446444,18387819,18266700,18314910,18285231,18281874,18297494,18283388,18291931,18332447,18301604,18391862,18294037,18279511,18322052,18316501,18337622,18322085,18310715,18281523,18372390,18405873,18357298,18272927,18367725,18317843],"result":{"estimate":18349625.25967742,"r_square":0.9999662551158084}}]}


if (contents == null)
    d3.json("outputs.json", render);
else
    render(contents);
}

  </script>

</body>
</html>
